<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Âêâ‰ªñ Guitar</title>
  <style>
    body {
      background-color: #222;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }

    #chords {
      display: grid;
      grid-template-columns: repeat(4, 150px);
      grid-gap: 20px;
      justify-content: center;
      margin: 40px auto;
    }

    .chord {
      position: relative;
      border: 3px solid transparent;
      border-radius: 8px;
      transition: border-color 0.2s;
    }

    .chord.selected {
      border-color: yellow;
    }

    .chord img {
      width: 150px;
      height: 150px;
      border-radius: 8px;
      background-color: white;
    }

    .label {
      margin-top: 10px;
    }

    #countdown {
      position: fixed;
      top: 20px;
      right: 40px;
      font-size: 60px;
      font-weight: bold;
      color: yellow;
      display: none;
      z-index: 99;
    }
  </style>
</head>
<body>
  <h1>Âêâ‰ªñ Guitar</h1>
  <p>Êåâ <strong>1‚Äì8</strong> ÈÅ∏ÊìáÂíåÂº¶. Êåâ <strong>Á©∫ÁôΩÈçµ</strong> ÂΩàÂ•è</p>
  <p>Press <strong>1‚Äì8</strong> to select a chord. Press <strong>spacebar</strong> to strum.</p>

  <div id="chords"></div>
  <div id="countdown">4</div>

  <script>
    const socket = new WebSocket("ws://172.27.120.175:8080");

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    async function loadAudio(note, url) {
      const res = await fetch(url);
      const arrayBuffer = await res.arrayBuffer();
      audioBuffers[note] = await audioCtx.decodeAudioData(arrayBuffer);
    }
    function playAudio(note) {
      const buffer = audioBuffers[note];
      if (!buffer) return;
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start();
    }

    const chordCount = 8;
    let selectedChord = null;
    let recording = false;
    let startTime = null;

    const audioMap = {};
    loadAudio("metronome", "http://localhost:8000/assets/audio/metronome.wav");
    loadAudio("metronomeMain", "http://localhost:8000/assets/audio/metronome_main.wav");
    const chordsContainer = document.getElementById("chords");
    const countdown = document.getElementById("countdown");

    for (let i = 1; i <= chordCount; i++) {
      const chordDiv = document.createElement("div");
      chordDiv.className = "chord";
      chordDiv.dataset.chord = i;

      const img = document.createElement("img");
      img.src = `assets/images/chord${i}.png`;
      img.alt = `Chord ${i}`;
      
      const label = document.createElement("div");
      label.className = "label";
      label.innerText = `ÂíåÂº¶ ${i}\nChord ${i}`;

      chordDiv.appendChild(img);
      chordDiv.appendChild(label);
      chordsContainer.appendChild(chordDiv);

      loadAudio(`chord${i}`, `http://localhost:8000/assets/audio/chord${i}.wav`);
    }

    function highlightSelectedChord(chordNum) {
      document.querySelectorAll('.chord').forEach(div => {
        div.classList.toggle('selected', parseInt(div.dataset.chord) === chordNum);
      });
    }

    document.addEventListener('keydown', (e) => {
      const key = e.key;

      if (key >= '1' && key <= '8') {
        selectedChord = parseInt(key);
        highlightSelectedChord(selectedChord);
      }

      if (key === ' ' && selectedChord) {
        playAudio(`chord${selectedChord}`);

        socket.send(JSON.stringify({
          playerId: "guitarist",
          chord: selectedChord,
          clientTime: Date.now()
        }));
      }
    });

    function runCountdown() {
      const sequence = ["Ready?", "1", "2", "3", "4"];
      let count = 0;
      
      socket.send(JSON.stringify({
        type: "ready",
        playerId: "guitarist", // drummer / pianist / guitarist
        readyTime: Date.now()
      }));

      const interval = setInterval(() => {
        countdown.style.display = "block";
        countdown.textContent = sequence[count];
        count++;
        if(count > 2)playAudio("metronome");
        else if(count === 2)playAudio("metronomeMain");
        if (count === sequence.length) {
          clearInterval(interval);
          setTimeout(() => {
            countdown.style.display = "none";
            recording = true;
            //startTime = Date.now();
          }, 500);
        }
      }, 500);
    }

    socket.addEventListener('message', (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "startAt") {
        const wait = msg.startAt - Date.now();
        if (wait < 0) {
          console.warn("‚ö†Ô∏è Missed start time, starting immediately");
          runCountdown();
        } else {
          setTimeout(runCountdown, wait);
        }
      } else if (msg.type === "stop") {
        recording = false;
      } else if (msg.type === "reset") {
        recording = false;
        startTime = null;
        countdown.style.display = "none";
      }
    });

    socket.addEventListener('open', () => console.log("üé∏ Connected to host"));
    socket.addEventListener('close', () => console.log("Disconnected from host"));
  </script>
</body>
</html>

