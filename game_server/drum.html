<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>鼓組 Drums</title>
  <style>
    body {
      background-color: #222;
      color: white;
      text-align: center;
      font-family: sans-serif;
    }

    .drum {
      display: inline-block;
      margin: 20px;
      position: relative;
    }

    .drum img {
      width: 200px;
      height: 200px;
      transition: transform 0.1s ease;
    }

    .drum.hit img {
      transform: scale(1.1);
      filter: brightness(1.5);
    }

    #countdown {
      position: fixed;
      top: 20px;
      right: 40px;
      font-size: 60px;
      font-weight: bold;
      color: yellow;
      display: none;
      z-index: 99;
    }
  </style>
</head>
<body>
  <h1>鼓組 Drums</h1>
  <p>按 <strong>k</strong> 打大鼓, <strong>f</strong> 或 <strong>m</strong> 打小鼓</p>
  <p>Press <strong>k</strong> to play Bass Drum, <strong>f</strong> or <strong>m</strong> to play Snare Drum</p>

  <div class="drum" id="snare">
    <img src="assets/snare.png" alt="Snare Drum">
    <p>小鼓 (f / m)</p>
    <p>Snare Drum (f / m)</p>
  </div>

  <div class="drum" id="bass">
    <img src="assets/bass.png" alt="Bass Drum">
    <p>大鼓 (k)</p>
    <p>Bass Drum (k)</p>
  </div>

  <div id="countdown">4</div>

  <script>
    const socket = new WebSocket("ws://172.27.120.175:8080");
    const bass = document.getElementById("bass");
    const snare = document.getElementById("snare");
    const countdown = document.getElementById("countdown");
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const audioBuffers = {};
    async function loadAudio(note, url) {
      const res = await fetch(url);
      const arrayBuffer = await res.arrayBuffer();
      audioBuffers[note] = await audioCtx.decodeAudioData(arrayBuffer);
    }
    function playAudio(note) {
      const buffer = audioBuffers[note];
      if (!buffer) return;
      const source = audioCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(audioCtx.destination);
      source.start();
    }
    async function loadSounds(){
      await loadAudio("bass", "http://localhost:8000/assets/bass.wav");
      await loadAudio("snare", "http://localhost:8000/assets/snare.wav");
      await loadAudio("metronome", "http://localhost:8000/assets/audio/metronome.wav");
      await loadAudio("metronomeMain", "http://localhost:8000/assets/audio/metronome_main.wav");
    }

    let recording = false;
    let startTime = null;
    let beatLoop = null;

    function playAndAnimate(type) {
      if (type === "bass") {
        bass.classList.add("hit");
        playAudio("bass");
        setTimeout(() => bass.classList.remove("hit"), 100);
      } else if (type === "snare") {
        snare.classList.add("hit");
        playAudio("snare");
        setTimeout(() => snare.classList.remove("hit"), 100);
      }
    }

    document.addEventListener('keydown', async(event) => {
      if (audioCtx.state !== "running") {
        await audioCtx.resume();
      }
      const key = event.key.toLowerCase();
      const now = Date.now();
      let action = null;

      if (key === 'k') action = "bass";
      if (key === 'f' || key === 'm') action = "snare";

      if (action) {
        playAndAnimate(action);
        socket.send(JSON.stringify({
          playerId: "drummer",
          action,
          clientTime: now
        }));
      }
    });

    function runCountdown() {
      const sequence = ["Ready?", "1", "2", "3", "4"];
      let count = 0;
      
      socket.send(JSON.stringify({
        type: "ready",
        playerId: "drummer", // drummer / pianist / guitarist
        readyTime: Date.now()
      }));

      const interval = setInterval(() => {
        countdown.style.display = "block";
        countdown.textContent = sequence[count];
        count++;
        if(count > 2)playAudio("metronome");
        else if(count === 2)playAudio("metronomeMain");
        if (count === sequence.length) {
          clearInterval(interval);
          setTimeout(() => {
            
            recording = true;
            //startTime = Date.now();
            let beat = 0;
            beatLoop = setInterval(() => {
              if (beat % 4 === 0){
                playAudio("metronomeMain");
              }
              else{
                playAudio("metronome");  
              }
              beat++;
              countdown.style.display = "none";
            }, 500);
          }, 0);
        }
        
      }, 500);
    }

    socket.addEventListener('message', (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "startAt") {
        const wait = msg.startAt - Date.now();
        if (wait < 0) {
          console.warn("⚠️ Missed start time, starting immediately");
          runCountdown();
        } else {
          setTimeout(runCountdown, wait);
        }
      } else if (msg.type === "stop") {
        recording = false;
        if (beatLoop){
          clearInterval(beatLoop);
          beatLoop = null;
        }
      } else if (msg.type === "reset") {
        recording = false;
        startTime = null;
        countdown.style.display = "none";
        if (beatLoop){
          clearInterval(beatLoop);
          beatLoop = null;
        }
      }
    });

    socket.addEventListener('open', () => console.log("🥁 Connected to host"));
    socket.addEventListener('close', () => console.log("Disconnected from host"));
    loadSounds().then(() => {
      console.log("✅ Sounds fully loaded");
    });
  </script>
</body>
</html>

